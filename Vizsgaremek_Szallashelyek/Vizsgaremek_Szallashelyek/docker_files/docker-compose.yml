name: mysql-stack

networks:
    dbnet:
        name: mysql-dbnet

services:
    mysql:
        image: mysql:8.4
        container_name: mysql
        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            MYSQL_USER: ${MYSQL_USER}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD:-AppUser!123}
            MYSQL_DATABASE: ${MYSQL_ADD_DB}
            MYSQL_ADD_DB: ${MYSQL_ADD_DB}
            MYSQL_DATABASES: ${MYSQL_DATABASES}
        command:
            - "mysqld"
            - "--character-set-server=utf8mb4"
            - "--collation-server=utf8mb4_0900_ai_ci"
            - "--sql-mode="
        ports:
            - ${MYSQL_PORT:-3306}:3306
        networks:
            dbnet:
                aliases: ["mysql"]
        volumes:
            - mysql_data:/var/lib/mysql
            - ./my.cnf:/etc/mysql/conf.d/zz-config.cnf:ro
            - ./init:/docker-entrypoint-initdb.d:ro
        healthcheck:
            test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -p$${MYSQL_ROOT_PASSWORD} --silent"]
            interval: 5s
            timeout: 5s
            retries: 20
            start_period: 20s
        restart: unless-stopped

    phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        container_name: phpmyadmin
        environment:
            PMA_HOST: mysql
            PMA_PORT: ${MYSQL_PORT:-3306}
            UPLOAD_LIMIT: 256M
            PMA_ABSOLUTE_URI: "http://localhost:${PHPMYADMIN_PORT}"
        ports:
            - "${PHPMYADMIN_PORT}:80"
        depends_on:
            - mysql
        networks:
            - dbnet
        restart: unless-stopped

volumes:
    mysql_data: